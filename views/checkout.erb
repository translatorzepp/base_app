<!DOCTYPE html>
<html>

<!-- TO DO: standardize '' vs "" -->

<head>

  <style>
    .form-element {
      width: 33%;
      word-wrap: break-word;
    }
    .hosted-container {
      height: 20px;
      background-color: #C8D6E8;
    }
    body {
      font-family: monospace;
    }
  </style>

</head>

<body>

  <h3>Checkout: <%= @customer_name %></h3>

  <p>
    <button type="button" onclick="goback()">Choose a Different Customer</button>
  </p>

  <form id="drop-in-checkout" action="/create_transaction" method="post">

    <p class="form-element">
      $<input name="amount" id="amount" placeholder="amount" size="8" required>
      <select name="currency" id="currency">
        <!-- TO DO?: update these values with constants -->
        <option value="USD">USD</option>
        <option value="CAD">CAD</option>
        <option value="EUR">EUR</option>
        <option value="GBP">GBP</option>
      </select>
    </p>
    <p class="form-element"> <%= @last_transaction_info %> </p>

    <div id="dropin-container" class="form-element"></div>

    <p>
      <input type="checkbox" name="subscription" id="subscription" value="true" unchecked disabled="true">Give this amount every month from now on</input>
    </p>

    <p>
      <input type="hidden" name="noncense" id="noncense" value="not a nonce">
      <input type="hidden" name="device_data" id="device_data" value="not device data">
    </p>
    
    <input type="submit" value="Pay Now!" />

  </form>

  <br />

  <a href="https://sandbox.braintreegateway.com/merchants/ryqy4yyw7m5bf92h/verified" target="_blank">
    <img src="https://s3.amazonaws.com/braintree-badges/braintree-badge-wide-dark.png" width="220px" height="35px" border="0"/>
  </a>

  <p>
    Accepted payment methods with each currencyâ€”
    <ul style="list-style-type: none">
      <li>USD: PayPal, American Express, JCB, Maestro, MasterCard, Visa, Coinbase, Apple Pay</li>
      <li>CAD: Coinbase, Discover, MasterCard, Visa, PayPal, Apple Pay</li>
      <li>EUR: MasterCard, Visa, UnionPay, Coinbase, Apple Pay</li>
      <li>GBP: Coinbase, Discover, MasterCard, Visa, UnionPay, Apple Pay</li>
    </ul>
  </p>
 
  <script src="https://js.braintreegateway.com/js/braintree-2.20.0.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

  <script>
    $(document).ready(function() {
      console.log("present_subscription_checkbox: <%= @present_subscription_checkbox %>");
      if ("<%= @present_subscription_checkbox %>" === "true") {
        $("#subscription").prop("disabled", false);
      }
    });
    
    braintree.setup(
      "<%= @client_token %>",
      "dropin",
      {
        container: "dropin-container",
        paypal: {
          singleUse: false,
          locale: 'en_us',
          displayName: "HIJACKED: THE DYAD INSTITUTE",
          enableShippingAddress: true,
          enableBillingAddress: true,
          onSuccess: function (nonce, err) {
            console.log("PayPal success: " + nonce);
            // console.log(err);
          },
          onCancelled: function (obj) {
            console.log("PayPal cancelled.");
          },
        },
        dataCollector: {
          kount: {environment: 'sandbox'},
          paypal: true,
        },
        onError: function (obj) {
          // console.log("Error! " + JSON.stringify(obj));
          alert("error");
        },
        onReady: function (braintreeInstance) {
          console.log("Ready! " + JSON.stringify(braintreeInstance));
          // Populate hidden device data field with device data generated by braintree.js:
          $("#device_data").val(braintreeInstance.deviceData);
          // // Log current contents of device data hidden field to test that it's populated with the correct value:
          // console.log($("#device_data").val()); 
        },
        onPaymentMethodReceived: function (obj) {
          // Check if the payment method received is of type PayPalAccount or CreditCard
          // to determine if we should run 3ds verification:
          if (obj.type === "CreditCard") {
            // Declare client for 3ds:
            var client = new braintree.api.Client({
              clientToken: "<%= @client_token %>"
            });
            // Verify 3ds:
            client.verify3DS({
              amount: $("#amount").val(),
              creditCard: obj.nonce,
            }, function (threeDSerror, threeDSresponse) {
              if (!threeDSerror) {
                console.log(JSON.stringify(threeDSresponse));
                $("#noncense").val(threeDSresponse.nonce);
                console.log("noncense value: " + $("#noncense").val());
                $("#drop-in-checkout").submit();
              } else {
                alert("Error while attempting to run 3D Secure validation: " + threeDSerror.message + ". Please try again.");
                console.log(threeDSerror.message);
              }
            });
          } else {
            console.log(JSON.stringify(obj));
            // TO DO: CONSOLIDATE THIS WITH THE !error CONDITION W/IN VERIFY 3DS ?
            $("#noncense").val(obj.nonce);
            console.log("noncense value: " + $("#noncense").val());
            $("#drop-in-checkout").submit();
          }
        },
      }
    );

    // TO DO: worry if onclick is bad style and if I should use jquery instead
    function goback () {
     window.location = '/';
    }

  </script>

</body>

</html>